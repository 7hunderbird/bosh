#!/usr/bin/env bash

set -eu

<% if p('director.db.host') == "127.0.0.1" or p('director.db.host') == "localhost" or p('director.db.host') == "::1" %>
if [ -z "$ARTIFACT_DIRECTORY" ]; then
  echo "\$ARTIFACT_DIRECTORY should not be empty! Refusing to back up." >&2
  exit 1
fi

# BBR does not clean out the backup directory
rm -rf $ARTIFACT_DIRECTORY/*

source /var/vcap/packages/ruby-2.4-r4/bosh/runtime.env
PATH=$PATH:/var/vcap/jobs/director/bin

set +u
# Postgres
PATH=/var/vcap/packages/postgres-9.4/bin:$PATH
LD_LIBRARY_PATH=/var/vcap/packages/libpq/lib:$LD_LIBRARY_PATH

# MySQL
PATH=/var/vcap/packages/mysql/bin:$PATH
LD_LIBRARY_PATH=/var/vcap/packages/mysql/lib/mysql:$LD_LIBRARY_PATH
set -u

export LD_LIBRARY_PATH
export PATH

export BUNDLE_GEMFILE=/var/vcap/packages/director/Gemfile
export GEM_HOME=/var/vcap/packages/director/gem_home/ruby/2.4.0

/var/vcap/packages/director/bin/bosh-backup
<% end %>
