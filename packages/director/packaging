set -e

mkdir -p ${BOSH_INSTALL_TARGET}/{bin,gem_home}

libpq_dir=/var/vcap/packages/libpq
mysqlclient_dir=/var/vcap/packages/mysql

gem install bundler -i /var/vcap/packages/bundler/gems
bundle update --bundler

source /var/vcap/packages/ruby-2.6.3-r0.14.0/bosh/compile.env

gem install -f /var/vcap/packages/bundler/bundler.gem

for gemspec in $( find . -maxdepth 2 -name *.gemspec ); do
  gem_name="$( basename "$( dirname "$gemspec" )" )"
  gem_spec="$( basename "$gemspec" )"

  pushd "$gem_name"
    gem build "$gem_spec"
    mv *.gem ../vendor/cache
  popd > /dev/null
done

cat > Gemfile <<EOF
# Explicitly require vendored version to avoid requiring builtin json gem
gem 'json', '2.1.0'

gem 'bosh-director'
gem 'mysql2'
gem 'pg'
EOF

if [ "`uname -m`" == "ppc64le" ]; then
    bundle config build.nokogiri '--use-system-libraries'
fi

bundle config build.mysql2 \
  --with-mysql-config=$mysqlclient_dir/bin/mariadb_config \

bundle config build.pg \
  --with-pg-lib=$libpq_dir/lib \
  --with-pg-include=$libpq_dir/include

# temporary hack until https://github.com/bundler/bundler/pull/7023 is published in bundler (probably 2.0.3)
gem install -i ${BOSH_INSTALL_TARGET}/gem_home -n ${BOSH_INSTALL_TARGET}/bin vendor/cache/pg-*.gem -- --with-pg-lib=$libpq_dir/lib --with-pg-include=$libpq_dir/include

bundle install \
  --local \
  --no-prune \
  --binstubs ${BOSH_INSTALL_TARGET}/bin \
  --path ${BOSH_INSTALL_TARGET}/gem_home

cp Gemfile ${BOSH_INSTALL_TARGET}
cp Gemfile.lock ${BOSH_INSTALL_TARGET}
